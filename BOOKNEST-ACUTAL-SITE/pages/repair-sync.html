<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookNest Repair Tool</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; max-width: 800px; margin: 0 auto; background: #f3f4f6; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #dc2626; margin-top: 0; }
        .user-item { background: #f9fafb; padding: 1rem; margin: 0.5rem 0; border: 1px solid #e5e7eb; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .status { font-weight: bold; }
        .status.pending { color: #d97706; }
        .status.success { color: #059669; }
        .status.error { color: #dc2626; }
        button { background: #2563eb; color: white; border: none; padding: 1rem 2rem; font-size: 1.2rem; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 1rem; }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        pre { background: #1f2937; color: #10b981; padding: 1rem; border-radius: 8px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üîß Account Repair Tool</h1>
        <p>Use this tool on the browser where you are <strong>ALREADY LOGGED IN</strong>.</p>
        <p>This will force-upload your local account data to the cloud database so you can log in on other devices.</p>
        
        <div id="statusArea">
            <h3>Local Accounts Found:</h3>
            <div id="userList">Scanning...</div>
        </div>

        <button id="syncBtn" onclick="startSync()">üöÄ FIX MY ACCOUNT NOW</button>
        
        <h3>Debug Log:</h3>
        <pre id="debugLog">// Ready...</pre>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- App Scripts -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/firestore-backend.js"></script>

    <script>
        function log(msg) {
            const el = document.getElementById('debugLog');
            el.textContent += '\n' + msg;
            console.log(msg);
        }

        function renderUsers() {
            const list = document.getElementById('userList');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const legacyUsers = JSON.parse(localStorage.getItem('booknest_users') || '[]');
            
            // Merge
            const allUsers = [...users];
            legacyUsers.forEach(u => {
                if (!allUsers.find(existing => existing.email === u.email)) {
                    allUsers.push(u);
                }
            });

            if (allUsers.length === 0) {
                list.innerHTML = '<p>No local accounts found on this browser.</p>';
                document.getElementById('syncBtn').disabled = true;
                return;
            }

            list.innerHTML = allUsers.map(u => `
                <div class="user-item">
                    <div>
                        <strong>${u.name || 'Unknown'}</strong><br>
                        <small>${u.email}</small>
                    </div>
                    <span class="status pending" id="status-${u.id}">Waiting...</span>
                </div>
            `).join('');
            
            window.localUsersToSync = allUsers;
        }

        async function startSync() {
            const btn = document.getElementById('syncBtn');
            btn.disabled = true;
            btn.textContent = 'Fixing... Please Wait...';
            
            if (!window.backend || !window.backend.db) {
                log('‚ùå Error: Database connection not ready. Reloading page...');
                setTimeout(() => location.reload(), 2000);
                return;
            }

            log('üöÄ Starting sync process...');
            
            for (const user of window.localUsersToSync) {
                const statusEl = document.getElementById(`status-${user.id}`);
                try {
                    log(`Processing user: ${user.email}...`);
                    
                    // 1. Check if exists
                    const docRef = window.backend.db.collection('users').doc(user.id);
                    await docRef.set(user, { merge: true });
                    
                    statusEl.textContent = 'FIXED ‚úÖ';
                    statusEl.className = 'status success';
                    log(`‚úÖ Successfully uploaded ${user.email}`);
                } catch (e) {
                    statusEl.textContent = 'FAILED ‚ùå';
                    statusEl.className = 'status error';
                    log(`‚ùå Failed to upload ${user.email}: ${e.message}`);
                }
            }

            log('‚ú® Process complete!');
            btn.textContent = '‚úÖ REPAIR COMPLETE';
            alert('Repair Complete! You can now try logging in on the other browser.');
        }

        // Init
        setTimeout(renderUsers, 500);
    </script>
</body>
</html>